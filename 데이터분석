# 1. ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, r2_score
from sklearn.preprocessing import LabelEncoder

# 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (Colabì— íŒŒì¼ ì—…ë¡œë“œí•˜ëŠ” ë°©ë²• í¬í•¨)
from google.colab import files
uploaded = files.upload()  # ì—…ë¡œë“œì°½ ì—´ë¦¼

df = pd.read_csv(list(uploaded.keys())[0])
print("ë°ì´í„° ëª¨ì–‘:", df.shape)
df.head()

# 3. ì „ì²˜ë¦¬
# Label Encoding: ë²”ì£¼í˜•(ë¬¸ìí˜•) -> ìˆ«ìë¡œ ë³€í™˜
le_biz = LabelEncoder()
le_sex = LabelEncoder()

df['ì—…ì¢…ì½”ë“œ'] = le_biz.fit_transform(df['card_tpbuz_nm_2'])
df['ì„±ë³„ì½”ë“œ'] = le_sex.fit_transform(df['sex'])

# ì‚¬ìš©ë  í”¼ì²˜ì™€ íƒ€ê²Ÿ ì •ì˜
X = df[['ì—…ì¢…ì½”ë“œ', 'ì„±ë³„ì½”ë“œ', 'age', 'day', 'cnt']]
y = df['amt']

# 4. í•™ìŠµìš©/í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ë‚˜ëˆ„ê¸°
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 5. ëª¨ë¸ í•™ìŠµ
model = RandomForestRegressor(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# 6. ì˜ˆì¸¡ ë° í‰ê°€
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

print(f"ğŸ“Š MSE: {mse:,.2f}")
print(f"ğŸ“ˆ R2 Score: {r2:.4f}")

# 7. ì¤‘ìš” ë³€ìˆ˜ í™•ì¸
import matplotlib.pyplot as plt

importances = model.feature_importances_
features = X.columns
indices = np.argsort(importances)

plt.figure(figsize=(8, 6))
plt.title("ğŸ“Œ Feature Importances")
plt.barh(range(len(indices)), importances[indices], align="center")
plt.yticks(range(len(indices)), [features[i] for i in indices])
plt.xlabel("Importance")
plt.show()
